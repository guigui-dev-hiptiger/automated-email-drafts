
AIを活用したGmail返信下書き自動作成GAS機能仕様書


概要
本GASスクリプトは、Gmailに届いた未読メールのうち、特定条件を満たすものに対してAIが自動で返信下書きを作成するツールです。署名の自動挿入、元のメールの引用、社内・社外のメールトーン自動切り替え、およびスプレッドシートを用いた除外リスト管理機能を備え、日常のメール業務を効率化します。

機能一覧
1. 未読メールの監視とフィルタリング
Gmailの受信トレイにある未読メールを定期的に検索します（GmailApp.search('is:unread to:me', 0, 10)）。
Toに自分のメールアドレスが含まれるメールのみを処理対象とします。
2. 除外リストによるフィルタリング
スプレッドシートに記述された特定のメールアドレス、または特定のドメインからのメールは、下書き作成の対象から除外します。
除外されたメールは既読 (message.markRead()) に設定され、次回以降の処理対象から外れます。
除外リストはスプレッドシートから動的に読み込むため、スクリプトのコード編集なしで更新・管理が可能です。
3. AIによる返信本文の生成
OpenAI API (gpt-4) を利用し、受信したメール本文（プレーンテキスト）に基づいて返信内容を生成します。
AIへのプロンプトには、ユーザーが定義した「メール文面の特徴」が含まれ、社外向けと社内向けで異なるスタイルを適用するようAIに指示します。
4. メールトーンの自動切り替え（社内・社外判定）
送信元のメールアドレスのドメインが、スクリプト内で定義された「自社ドメイン」と一致する場合、そのメールは「社内メール」と判断されます。
AIへのプロンプト生成時、この判定結果に基づいて「社内向けメール」または「社外向けメール」の文面特徴をAIに伝達し、適切なトーンでの返信を促します。
5. 返信下書きの作成
生成されたAIの返信本文、定義済みの署名、および元のメールの引用を組み合わせて、HTML形式のメール下書きを作成します。
引用部分はGmailのネイティブ表示に近いHTML構造で整形されます。
返信件名には自動で "Re: " が付与され、さらに " [AI下書き]" が追記されます。
元のメールのCCリストを自動で引き継ぎ、さらに設定済みの追加CCアドレスも含まれます。
作成された下書きは、元のメールスレッドに紐付けられます (inReplyTo)。
下書きが作成されたメールは既読に設定されます。
6. スプレッドシート連携
除外リスト（メールアドレス、ドメイン）は指定されたGoogleスプレッドシートから読み込まれます。
スプレッドシートID: 14bKIesU8tT0ryGH09CrA_sy5lDpf2ROdJSzFVTjpScI
除外アドレスシート名: 除外アドレス
除外ドメインシート名: 除外ドメイン
スクリプトの実行時（タイムドリブントリガーなど）に最新のリストが読み込まれるため、スプレッドシートを更新するだけで除外設定を反映できます。
読み込みエラーが発生した場合はコンソールに警告またはエラーが出力され、スクリプトの実行は継続されます。
7. 環境設定
MY_EMAIL: 自身のGmailアドレスを設定します。
ADDITIONAL_CC: 全ての返信にCCとして含めたいメールアドレスを設定します。
MY_SIGNATURE: 下書きに自動挿入される署名を設定します。改行も反映されます。
EXCLUDE_LIST_SPREADSHEET_ID: 除外リストが記述されたスプレッドシートのIDを設定します。
EXCLUDE_ADDRESS_SHEET_NAME: 除外メールアドレスが記述されたシート名を指定します。
EXCLUDE_DOMAIN_SHEET_NAME: 除外ドメインが記述されたシート名を指定します。
MY_COMPANY_DOMAIN: 自社ドメインを設定します（例: cysista.co.jp）。
OpenAI APIキーはスクリプトプロパティ (PropertiesService) から安全に取得されます。

導入手順
本GASスクリプトをGoogle Apps Scriptプロジェクトに貼り付けます。
スクリプト内の定数 (MY_EMAIL, ADDITIONAL_CC, MY_SIGNATURE, EXCLUDE_LIST_SPREADSHEET_ID, EXCLUDE_ADDRESS_SHEET_NAME, EXCLUDE_DOMAIN_SHEET_NAME, MY_COMPANY_DOMAIN) を自身の環境に合わせて設定します。
OpenAI APIキーをスクリプトプロパティに設定します。（キー: OPENAI_API_KEY, 値: あなたのAPIキー）
除外リスト用のGoogleスプレッドシートを作成し、「除外アドレス」シートと「除外ドメイン」シートにそれぞれ除外したいメールアドレスおよびドメインをA列に記述します。
checkAndDraftReply 関数に対し、タイムドリブントリガーを設定し、任意の頻度で自動実行されるようにします。

注意事項
GmailApp.search の取得数上限は10スレッドです。大量の未読メールがある場合は、実行頻度や取得数を調整する必要があるかもしれません。
スプレッドシートの読み込みには権限承認が必要です。初回実行時に承認プロンプトが表示されます。
generateReplyWithOpenAI 関数内のモデル (gpt-4) は必要に応じて更新してください。
生成される下書きはAIによるものであり、送信前には必ず内容を確認・修正してください。


